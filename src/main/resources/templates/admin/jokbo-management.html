<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'족보 관리 - ' + ${book.title}">족보 관리 - 세종족보</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .book-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .book-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .jokbo-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .jokbo-table th,
        .jokbo-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .jokbo-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-waiting {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-approve, .btn-reject, .btn-view, .btn-download {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-approve {
            background: #28a745;
            color: white;
        }
        
        .btn-reject {
            background: #dc3545;
            color: white;
        }
        
        .btn-view {
            background: #17a2b8;
            color: white;
        }
        
        .btn-download {
            background: #6c757d;
            color: white;
        }
        
        .btn-approve:hover, .btn-reject:hover, .btn-view:hover, .btn-download:hover {
            opacity: 0.8;
        }
        
        .content-preview {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .no-jokbo {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            background: #dc2626;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .back-button:hover {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <a href="/" class="back-button">← 홈으로 돌아가기</a>
        
        <div class="book-info">
            <h1 class="book-title" th:text="${book.title}">책 제목</h1>
            <p th:if="${book.author}"><strong>저자:</strong> <span th:text="${book.author}">저자명</span></p>
            <p th:if="${book.publisher}"><strong>출판사:</strong> <span th:text="${book.publisher}">출판사명</span></p>
            <p th:if="${book.category}"><strong>카테고리:</strong> <span th:text="${book.category}">카테고리</span></p>
        </div>
        
        <h2>족보 관리</h2>
        
        <div th:if="${#lists.isEmpty(jokbos)}" class="no-jokbo">
            <p>등록된 족보가 없습니다.</p>
        </div>
        
        <div th:if="${!#lists.isEmpty(jokbos)}">
            <table class="jokbo-table">
                <thead>
                    <tr>
                        <th>등록자</th>
                        <th>등록일</th>
                        <th>내용</th>
                        <th>상태</th>
                        <th>코멘트</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="jokbo : ${jokbos}">
                        <td th:text="${jokbo.uploaderName}">등록자</td>
                        <td th:text="${#temporals.format(jokbo.createdAt, 'yyyy-MM-dd HH:mm')}">등록일</td>
                        <td>
                            <!-- 텍스트 족보인 경우 -->
                            <div th:if="${jokbo.contentType == 'text'}" class="content-preview" th:text="${jokbo.contentUrl}">
                                족보 내용
                            </div>
                            <!-- 파일 족보인 경우 -->
                            <div th:if="${jokbo.contentType == 'file'}" class="content-preview" th:text="${jokbo.contentUrl}">
                                파일명
                            </div>
                        </td>
                        <td>
                            <span th:class="${'status-badge status-' + jokbo.status.name().toLowerCase()}" 
                                  th:text="${jokbo.status.name()}">상태</span>
                        </td>
                        <td th:text="${jokbo.comment}">코멘트</td>
                        <td>
                            <div class="action-buttons">
                                <!-- 승인 대기 중인 경우에만 승인/반려 버튼 표시 -->
                                <button th:if="${jokbo.status.name() == '대기'}" 
                                        th:onclick="'approveJokbo(' + ${jokbo.jokboId} + ')'" 
                                        class="btn-approve">승인</button>
                                <button th:if="${jokbo.status.name() == '대기'}" 
                                        th:onclick="'rejectJokbo(' + ${jokbo.jokboId} + ')'" 
                                        class="btn-reject">반려</button>
                                
                                <!-- 승인된 족보는 보기/다운로드 버튼 표시 -->
                                <a th:if="${jokbo.status.name() == '승인' && jokbo.contentType == 'file'}" 
                                   th:href="@{'/jokbo/view/' + ${jokbo.contentUrl}}" 
                                   target="_blank" class="btn-view">보기</a>
                                <a th:if="${jokbo.status.name() == '승인' && jokbo.contentType == 'file'}" 
                                   th:href="@{'/jokbo/download/' + ${jokbo.contentUrl}}" 
                                   class="btn-download">다운로드</a>
                                
                                <!-- 텍스트 족보는 내용 보기 -->
                                <button th:if="${jokbo.status.name() == '승인' && jokbo.contentType == 'text'}" 
                                        th:onclick="'viewTextJokbo(\'' + ${jokbo.contentUrl} + '\')'" 
                                        class="btn-view">내용보기</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 텍스트 족보 내용 보기 모달 -->
    <div id="textModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 600px; max-height: 80%; overflow-y: auto;">
            <h3>족보 내용</h3>
            <div id="textContent" style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0; white-space: pre-wrap;"></div>
            <button onclick="closeTextModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">닫기</button>
        </div>
    </div>
    
    <script th:inline="javascript">
        const bookId = [[${book.bookId}]];
        
        // 족보 승인
        function approveJokbo(jokboId) {
            if (confirm('이 족보를 승인하시겠습니까?')) {
                fetch(`/admin/jokbo/${jokboId}/approve`, {
                    method: 'POST'
                })
                .then(response => response.text())
                .then(result => {
                    if (result === 'success') {
                        alert('족보가 승인되었습니다.');
                        location.reload();
                    } else {
                        alert('승인에 실패했습니다: ' + result);
                    }
                })
                .catch(error => {
                    alert('오류가 발생했습니다: ' + error);
                });
            }
        }
        
        // 족보 반려
        function rejectJokbo(jokboId) {
            if (confirm('이 족보를 반려하시겠습니까?')) {
                fetch(`/admin/jokbo/${jokboId}/reject`, {
                    method: 'POST'
                })
                .then(response => response.text())
                .then(result => {
                    if (result === 'success') {
                        alert('족보가 반려되었습니다.');
                        location.reload();
                    } else {
                        alert('반려에 실패했습니다: ' + result);
                    }
                })
                .catch(error => {
                    alert('오류가 발생했습니다: ' + error);
                });
            }
        }
        
        // 텍스트 족보 내용 보기
        function viewTextJokbo(content) {
            document.getElementById('textContent').textContent = content;
            document.getElementById('textModal').style.display = 'block';
        }
        
        // 텍스트 모달 닫기
        function closeTextModal() {
            document.getElementById('textModal').style.display = 'none';
        }
        
        // 모달 외부 클릭 시 닫기
        document.getElementById('textModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTextModal();
            }
        });
    </script>
</body>
</html> 