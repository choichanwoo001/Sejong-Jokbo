<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${book.title} + ' - 세종족보'">책 제목 - 세종족보</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .book-detail {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-layout {
            display: flex;
            gap: 40px;
            margin-top: 20px;
        }
        
        .book-info {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            height: fit-content;
        }
        
        .book-image {
            width: 200px;
            height: 280px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .book-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .book-author, .book-publisher, .book-category {
            margin-bottom: 8px;
            color: #666;
        }
        
        .jokbo-section {
            flex: 2;
        }
        
        .jokbo-tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 30px;
        }
        
        .jokbo-tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .jokbo-tab.active {
            color: #dc2626;
            border-bottom-color: #dc2626;
        }
        
        .jokbo-content {
            display: none;
        }
        
        .jokbo-content.active {
            display: block;
        }
        
        .register-tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        
        .register-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .register-tab.active {
            color: #dc2626;
            border-bottom-color: #dc2626;
        }
        
        .register-content {
            display: none;
        }
        
        .register-content.active {
            display: block;
        }
        
        .jokbo-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .email-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .email-input {
            flex: 1;
        }
        
        .verify-button {
            background: #dc2626;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
            white-space: nowrap;
        }
        
        .verify-button:hover {
            background: #b91c1c;
        }
        
        .verify-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .verification-code-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-top: 10px;
        }
        
        .verification-code-input {
            flex: 1;
        }
        
        .form-button {
            background: #dc2626;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }
        
        .form-button:hover {
            background: #b91c1c;
        }
        
        .jokbo-list {
            display: grid;
            gap: 20px;
        }
        
        .jokbo-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .jokbo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .jokbo-uploader {
            font-weight: bold;
            color: #333;
        }
        
        .jokbo-date {
            color: #666;
            font-size: 0.9rem;
        }
        
        .jokbo-content-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        
        .jokbo-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-view, .btn-download {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .btn-view {
            background: #28a745;
            color: white;
        }
        
        .btn-download {
            background: #17a2b8;
            color: white;
        }
        
        .btn-view:hover, .btn-download:hover {
            opacity: 0.8;
        }
        
        .no-jokbo {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }
        
        .file-upload {
            border: 2px dashed #ddd;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .file-upload.dragover {
            border-color: #dc2626;
            background: #fef2f2;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #dc2626;
            text-decoration: none;
        }
        
        .back-link:hover {
            color: #b91c1c;
        }
        
        .verification-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .verification-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .verification-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
                gap: 20px;
            }
            
            .book-info {
                order: 1;
            }
            
            .jokbo-section {
                order: 2;
            }
            
            .email-group, .verification-code-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="book-detail">
        <a href="/" class="back-link">← 홈으로 돌아가기</a>
        
        <div class="main-layout">
            <!-- 책 정보 섹션 -->
            <div class="book-info">
                <img th:if="${book.imageUrl}" th:src="${book.imageUrl}" alt="책 표지" class="book-image">
                <div class="book-details">
                    <h1 class="book-title" th:text="${book.title}">책 제목</h1>
                    <p class="book-author" th:if="${book.author}">
                        <strong>저자:</strong> <span th:text="${book.author}">저자명</span>
                    </p>
                    <p class="book-publisher" th:if="${book.publisher}">
                        <strong>출판사:</strong> <span th:text="${book.publisher}">출판사명</span>
                    </p>
                    <p class="book-category" th:if="${book.category}">
                        <strong>카테고리:</strong> <span th:text="${book.category}">카테고리</span>
                    </p>
                </div>
            </div>
            
            <!-- 족보 섹션 -->
            <div class="jokbo-section">
                <h2>족보</h2>
                
                <!-- 족보 탭 -->
                <div class="jokbo-tabs">
                    <button class="jokbo-tab active" onclick="showJokboTab('register')">족보 등록</button>
                    <button class="jokbo-tab" onclick="showJokboTab('list')">족보 목록</button>
                </div>
                
                <!-- 족보 등록 탭 -->
                <div id="register" class="jokbo-content active">
                    <!-- 등록 방식 탭 -->
                    <div class="register-tabs">
                        <button class="register-tab active" onclick="showRegisterTab('text')">텍스트</button>
                        <button class="register-tab" onclick="showRegisterTab('file')">파일</button>
                    </div>
                    
                    <!-- 텍스트 족보 등록 -->
                    <div id="text-register" class="register-content active">
                        <div class="jokbo-form">
                            <h3>텍스트 족보 등록</h3>
                            <form id="textJokboForm">
                                <div class="form-group">
                                    <label class="form-label">등록자 이름</label>
                                    <input type="text" name="uploaderName" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">이메일</label>
                                    <div class="email-group">
                                        <input type="email" name="email" class="form-input email-input" required>
                                        <button type="button" class="verify-button" onclick="sendVerificationCode()">인증번호 발송</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">인증번호</label>
                                    <div class="verification-code-group">
                                        <input type="text" name="verificationCode" class="form-input verification-code-input" placeholder="인증번호를 입력하세요" required>
                                        <button type="button" class="verify-button" onclick="verifyCode()">인증확인</button>
                                    </div>
                                    <div id="verificationStatus" class="verification-status" style="display: none;"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">족보 내용</label>
                                    <textarea name="content" class="form-textarea" placeholder="족보 내용을 입력하세요..." required></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">코멘트 (선택사항)</label>
                                    <textarea name="comment" class="form-textarea" placeholder="추가 코멘트를 입력하세요..."></textarea>
                                </div>
                                <button type="submit" class="form-button">텍스트 족보 등록</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 파일 족보 등록 -->
                    <div id="file-register" class="register-content">
                        <div class="jokbo-form">
                            <h3>파일 족보 등록</h3>
                            <form id="fileJokboForm" enctype="multipart/form-data">
                                <div class="form-group">
                                    <label class="form-label">등록자 이름</label>
                                    <input type="text" name="uploaderName" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">이메일</label>
                                    <div class="email-group">
                                        <input type="email" name="email" class="form-input email-input" required>
                                        <button type="button" class="verify-button" onclick="sendVerificationCode()">인증번호 발송</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">인증번호</label>
                                    <div class="verification-code-group">
                                        <input type="text" name="verificationCode" class="form-input verification-code-input" placeholder="인증번호를 입력하세요" required>
                                        <button type="button" class="verify-button" onclick="verifyCode()">인증확인</button>
                                    </div>
                                    <div id="verificationStatus" class="verification-status" style="display: none;"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">족보 파일</label>
                                    <div class="file-upload" id="fileUpload">
                                        <p>파일을 드래그하여 놓거나 클릭하여 선택하세요</p>
                                        <input type="file" name="file" id="fileInput" style="display: none;" accept=".pdf,.jpg,.jpeg,.png,.gif,.txt" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">코멘트 (선택사항)</label>
                                    <textarea name="comment" class="form-textarea" placeholder="추가 코멘트를 입력하세요..."></textarea>
                                </div>
                                <button type="submit" class="form-button">파일 족보 등록</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- 족보 목록 탭 -->
                <div id="list" class="jokbo-content">
                    <div th:if="${#lists.isEmpty(jokbos)}" class="no-jokbo">
                        <p>등록된 족보가 없습니다.</p>
                    </div>
                    
                    <div th:if="${!#lists.isEmpty(jokbos)}" class="jokbo-list">
                        <div th:each="jokbo : ${jokbos}" class="jokbo-item">
                            <div class="jokbo-header">
                                <span class="jokbo-uploader" th:text="${jokbo.uploaderName}">등록자</span>
                                <span class="jokbo-date" th:text="${#temporals.format(jokbo.createdAt, 'yyyy-MM-dd HH:mm')}">등록일</span>
                            </div>
                            
                            <!-- 텍스트 족보인 경우 -->
                            <div th:if="${jokbo.contentType == 'text'}" class="jokbo-content-text" th:text="${jokbo.contentUrl}">
                                족보 내용
                            </div>
                            
                            <!-- 파일 족보인 경우 -->
                            <div th:if="${jokbo.contentType == 'file'}" class="jokbo-actions">
                                <a th:href="@{'/jokbo/view/' + ${jokbo.contentUrl}}" target="_blank" class="btn-view">보기</a>
                                <a th:href="@{'/jokbo/download/' + ${jokbo.contentUrl}}" class="btn-download">다운로드</a>
                            </div>
                            
                            <div th:if="${jokbo.comment}" class="jokbo-comment">
                                <strong>코멘트:</strong> <span th:text="${jokbo.comment}">코멘트</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        const bookId = /*[[${book.bookId}]]*/ 0;
        let verificationCode = '';
        let isEmailVerified = false;
        
        // 족보 탭 전환 함수
        function showJokboTab(tabName) {
            // 모든 탭과 콘텐츠 비활성화
            document.querySelectorAll('.jokbo-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.jokbo-content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭과 콘텐츠 활성화
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        // 등록 방식 탭 전환 함수
        function showRegisterTab(tabName) {
            // 모든 등록 탭과 콘텐츠 비활성화
            document.querySelectorAll('.register-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.register-content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭과 콘텐츠 활성화
            event.target.classList.add('active');
            document.getElementById(tabName + '-register').classList.add('active');
        }
        
        // 인증번호 발송
        function sendVerificationCode() {
            const email = event.target.parentElement.querySelector('input[type="email"]').value;
            
            if (!email) {
                alert('이메일을 입력해주세요.');
                return;
            }
            
            // 실제로는 서버에 인증번호 발송 요청
            fetch('/api/send-verification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    verificationCode = data.code; // 실제로는 서버에서 생성된 코드
                    alert('인증번호가 발송되었습니다.');
                    event.target.disabled = true;
                    event.target.textContent = '재발송';
                    setTimeout(() => {
                        event.target.disabled = false;
                        event.target.textContent = '인증번호 발송';
                    }, 60000); // 1분 후 재발송 가능
                } else {
                    alert('인증번호 발송에 실패했습니다.');
                }
            })
            .catch(error => {
                // 개발용 임시 코드 (실제 서버 없을 때)
                verificationCode = '123456';
                alert('인증번호가 발송되었습니다. (개발용: 123456)');
                event.target.disabled = true;
                event.target.textContent = '재발송';
                setTimeout(() => {
                    event.target.disabled = false;
                    event.target.textContent = '인증번호 발송';
                }, 60000);
            });
        }
        
        // 인증번호 확인
        function verifyCode() {
            const inputCode = event.target.parentElement.querySelector('input[name="verificationCode"]').value;
            const statusDiv = document.getElementById('verificationStatus');
            
            if (inputCode === verificationCode) {
                isEmailVerified = true;
                statusDiv.className = 'verification-status verification-success';
                statusDiv.textContent = '이메일 인증이 완료되었습니다.';
                statusDiv.style.display = 'block';
                event.target.disabled = true;
                event.target.textContent = '인증완료';
            } else {
                isEmailVerified = false;
                statusDiv.className = 'verification-status verification-error';
                statusDiv.textContent = '인증번호가 일치하지 않습니다.';
                statusDiv.style.display = 'block';
            }
        }
        
        // 텍스트 족보 등록
        document.getElementById('textJokboForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!isEmailVerified) {
                alert('이메일 인증을 완료해주세요.');
                return;
            }
            
            const formData = new FormData(this);
            
            fetch(`/book/${bookId}/jokbo/text`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(result => {
                if (result === 'success') {
                    alert('족보가 성공적으로 등록되었습니다.');
                    this.reset();
                    isEmailVerified = false;
                    document.getElementById('verificationStatus').style.display = 'none';
                } else {
                    alert('족보 등록에 실패했습니다: ' + result);
                }
            })
            .catch(error => {
                alert('오류가 발생했습니다: ' + error);
            });
        });
        
        // 파일 족보 등록
        document.getElementById('fileJokboForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!isEmailVerified) {
                alert('이메일 인증을 완료해주세요.');
                return;
            }
            
            const formData = new FormData(this);
            
            fetch(`/book/${bookId}/jokbo/file`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(result => {
                if (result === 'success') {
                    alert('족보가 성공적으로 등록되었습니다.');
                    this.reset();
                    document.getElementById('fileUpload').innerHTML = '<p>파일을 드래그하여 놓거나 클릭하여 선택하세요</p>';
                    isEmailVerified = false;
                    document.getElementById('verificationStatus').style.display = 'none';
                } else {
                    alert('족보 등록에 실패했습니다: ' + result);
                }
            })
            .catch(error => {
                alert('오류가 발생했습니다: ' + error);
            });
        });
        
        // 파일 업로드 UI
        const fileUpload = document.getElementById('fileUpload');
        const fileInput = document.getElementById('fileInput');
        
        fileUpload.addEventListener('click', () => fileInput.click());
        
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        });
        
        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragover');
        });
        
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            fileInput.files = e.dataTransfer.files;
            updateFileDisplay();
        });
        
        fileInput.addEventListener('change', updateFileDisplay);
        
        function updateFileDisplay() {
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileUpload.innerHTML = `<p>선택된 파일: ${file.name}</p>`;
            } else {
                fileUpload.innerHTML = '<p>파일을 드래그하여 놓거나 클릭하여 선택하세요</p>';
            }
        }
    </script>
</body>
</html> 